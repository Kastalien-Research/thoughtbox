---
url: "https://platform.claude.com/docs/en/agent-sdk/cost-tracking"
title: "Tracking Costs and Usage - Claude Docs"
---

[Claude Documentation Home](https://platform.claude.com/docs/en/home)

- [Developer Guide](https://platform.claude.com/docs/en/intro)
- [API Reference](https://platform.claude.com/docs/en/api/overview)
- [MCP](https://modelcontextprotocol.io/)
- [Resources](https://platform.claude.com/docs/en/resources/overview)
- [Release Notes](https://platform.claude.com/docs/en/release-notes/overview)

English

[Log in](https://platform.claude.com/login?returnTo=%2Fdocs%2Fen%2Fagent-sdk%2Fcost-tracking)

Search...

âŒ˜K

First steps

[Intro to Claude](https://platform.claude.com/docs/en/intro) [Quickstart](https://platform.claude.com/docs/en/get-started)

Models & pricing

[Models overview](https://platform.claude.com/docs/en/about-claude/models/overview) [Choosing a model](https://platform.claude.com/docs/en/about-claude/models/choosing-a-model) [What's new in Claude 4.5](https://platform.claude.com/docs/en/about-claude/models/whats-new-claude-4-5) [Migrating to Claude 4.5](https://platform.claude.com/docs/en/about-claude/models/migrating-to-claude-4) [Model deprecations](https://platform.claude.com/docs/en/about-claude/model-deprecations) [Pricing](https://platform.claude.com/docs/en/about-claude/pricing)

Build with Claude

[Features overview](https://platform.claude.com/docs/en/build-with-claude/overview) [Using the Messages API](https://platform.claude.com/docs/en/build-with-claude/working-with-messages) [Context windows](https://platform.claude.com/docs/en/build-with-claude/context-windows) [Prompting best practices](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/claude-4-best-practices)

Capabilities

[Prompt caching](https://platform.claude.com/docs/en/build-with-claude/prompt-caching) [Context editing](https://platform.claude.com/docs/en/build-with-claude/context-editing) [Extended thinking](https://platform.claude.com/docs/en/build-with-claude/extended-thinking) [Effort](https://platform.claude.com/docs/en/build-with-claude/effort) [Streaming Messages](https://platform.claude.com/docs/en/build-with-claude/streaming) [Batch processing](https://platform.claude.com/docs/en/build-with-claude/batch-processing) [Citations](https://platform.claude.com/docs/en/build-with-claude/citations) [Multilingual support](https://platform.claude.com/docs/en/build-with-claude/multilingual-support) [Token counting](https://platform.claude.com/docs/en/build-with-claude/token-counting) [Embeddings](https://platform.claude.com/docs/en/build-with-claude/embeddings) [Vision](https://platform.claude.com/docs/en/build-with-claude/vision) [PDF support](https://platform.claude.com/docs/en/build-with-claude/pdf-support) [Files API](https://platform.claude.com/docs/en/build-with-claude/files) [Search results](https://platform.claude.com/docs/en/build-with-claude/search-results) [Structured outputs](https://platform.claude.com/docs/en/build-with-claude/structured-outputs) [Google Sheets add-on](https://platform.claude.com/docs/en/agents-and-tools/claude-for-sheets)

Tools

[Overview](https://platform.claude.com/docs/en/agents-and-tools/tool-use/overview) [How to implement tool use](https://platform.claude.com/docs/en/agents-and-tools/tool-use/implement-tool-use) [Fine-grained tool streaming](https://platform.claude.com/docs/en/agents-and-tools/tool-use/fine-grained-tool-streaming) [Bash tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/bash-tool) [Code execution tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/code-execution-tool) [Programmatic tool calling](https://platform.claude.com/docs/en/agents-and-tools/tool-use/programmatic-tool-calling) [Computer use tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/computer-use-tool) [Text editor tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/text-editor-tool) [Web fetch tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/web-fetch-tool) [Web search tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/web-search-tool) [Memory tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/memory-tool) [Tool search tool](https://platform.claude.com/docs/en/agents-and-tools/tool-use/tool-search-tool)

Agent Skills

[Overview](https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview) [Quickstart](https://platform.claude.com/docs/en/agents-and-tools/agent-skills/quickstart) [Best practices](https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices) [Using Skills with the API](https://platform.claude.com/docs/en/build-with-claude/skills-guide)

Agent SDK

[Overview](https://platform.claude.com/docs/en/agent-sdk/overview) [Quickstart](https://platform.claude.com/docs/en/agent-sdk/quickstart) [TypeScript SDK](https://platform.claude.com/docs/en/agent-sdk/typescript) [TypeScript V2 (preview)](https://platform.claude.com/docs/en/agent-sdk/typescript-v2-preview) [Python SDK](https://platform.claude.com/docs/en/agent-sdk/python) [Migration Guide](https://platform.claude.com/docs/en/agent-sdk/migration-guide) Guides

[Streaming Input](https://platform.claude.com/docs/en/agent-sdk/streaming-vs-single-mode) [Handling Permissions](https://platform.claude.com/docs/en/agent-sdk/permissions) [Session Management](https://platform.claude.com/docs/en/agent-sdk/sessions) [Structured outputs in the SDK](https://platform.claude.com/docs/en/agent-sdk/structured-outputs) [Hosting the Agent SDK](https://platform.claude.com/docs/en/agent-sdk/hosting) [Securely deploying AI agents](https://platform.claude.com/docs/en/agent-sdk/secure-deployment) [Modifying system prompts](https://platform.claude.com/docs/en/agent-sdk/modifying-system-prompts) [MCP in the SDK](https://platform.claude.com/docs/en/agent-sdk/mcp) [Custom Tools](https://platform.claude.com/docs/en/agent-sdk/custom-tools) [Subagents in the SDK](https://platform.claude.com/docs/en/agent-sdk/subagents) [Slash Commands in the SDK](https://platform.claude.com/docs/en/agent-sdk/slash-commands) [Agent Skills in the SDK](https://platform.claude.com/docs/en/agent-sdk/skills) [Tracking Costs and Usage](https://platform.claude.com/docs/en/agent-sdk/cost-tracking) [Todo Lists](https://platform.claude.com/docs/en/agent-sdk/todo-tracking) [Plugins in the SDK](https://platform.claude.com/docs/en/agent-sdk/plugins)

MCP in the API

[MCP connector](https://platform.claude.com/docs/en/agents-and-tools/mcp-connector) [Remote MCP servers](https://platform.claude.com/docs/en/agents-and-tools/remote-mcp-servers)

Claude on 3rd-party platforms

[Amazon Bedrock](https://platform.claude.com/docs/en/build-with-claude/claude-on-amazon-bedrock) [Microsoft Foundry](https://platform.claude.com/docs/en/build-with-claude/claude-in-microsoft-foundry) [Vertex AI](https://platform.claude.com/docs/en/build-with-claude/claude-on-vertex-ai)

Prompt engineering

[Overview](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/overview) [Prompt generator](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/prompt-generator) [Use prompt templates](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/prompt-templates-and-variables) [Prompt improver](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/prompt-improver) [Be clear and direct](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/be-clear-and-direct) [Use examples (multishot prompting)](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/multishot-prompting) [Let Claude think (CoT)](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/chain-of-thought) [Use XML tags](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/use-xml-tags) [Give Claude a role (system prompts)](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/system-prompts) [Prefill Claude's response](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/prefill-claudes-response) [Chain complex prompts](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/chain-prompts) [Long context tips](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/long-context-tips) [Extended thinking tips](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/extended-thinking-tips)

Test & evaluate

[Define success criteria](https://platform.claude.com/docs/en/test-and-evaluate/define-success) [Develop test cases](https://platform.claude.com/docs/en/test-and-evaluate/develop-tests) [Using the Evaluation Tool](https://platform.claude.com/docs/en/test-and-evaluate/eval-tool) [Reducing latency](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/reduce-latency)

Strengthen guardrails

[Reduce hallucinations](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/reduce-hallucinations) [Increase output consistency](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/increase-consistency) [Mitigate jailbreaks](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/mitigate-jailbreaks) [Streaming refusals](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/handle-streaming-refusals) [Reduce prompt leak](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/reduce-prompt-leak) [Keep Claude in character](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/keep-claude-in-character)

Administration and monitoring

[Admin API overview](https://platform.claude.com/docs/en/build-with-claude/administration-api) [Usage and Cost API](https://platform.claude.com/docs/en/build-with-claude/usage-cost-api) [Claude Code Analytics API](https://platform.claude.com/docs/en/build-with-claude/claude-code-analytics-api)

[Console](https://platform.claude.com/)

[Log in](https://platform.claude.com/login)

Guides

Tracking Costs and Usage

Guides

# Tracking Costs and Usage

Copy page

Understand and track token usage for billing in the Claude Agent SDK

Copy page

# SDK Cost Tracking

The Claude Agent SDK provides detailed token usage information for each interaction with Claude. This guide explains how to properly track costs and understand usage reporting, especially when dealing with parallel tool uses and multi-step conversations.

For complete API documentation, see the [TypeScript SDK reference](https://platform.claude.com/docs/en/agent-sdk/typescript).

## Understanding Token Usage

When Claude processes requests, it reports token usage at the message level. This usage data is essential for tracking costs and billing users appropriately.

### Key Concepts

1. **Steps**: A step is a single request/response pair between your application and Claude
2. **Messages**: Individual messages within a step (text, tool uses, tool results)
3. **Usage**: Token consumption data attached to assistant messages

## Usage Reporting Structure

### Single vs Parallel Tool Use

When Claude executes tools, the usage reporting differs based on whether tools are executed sequentially or in parallel:

TypeScript

```
import { query } from "@anthropic-ai/claude-agent-sdk";

// Example: Tracking usage in a conversation
const result = await query({
  prompt: "Analyze this codebase and run tests",
  options: {
    onMessage: (message) => {
      if (message.type === 'assistant' && message.usage) {
        console.log(`Message ID: ${message.id}`);
        console.log(`Usage:`, message.usage);
      }
    }
  }
});
```

### Message Flow Example

Here's how messages and usage are reported in a typical multi-step conversation:

```
<!-- Step 1: Initial request with parallel tool uses -->
assistant (text)      { id: "msg_1", usage: { output_tokens: 100, ... } }
assistant (tool_use)  { id: "msg_1", usage: { output_tokens: 100, ... } }
assistant (tool_use)  { id: "msg_1", usage: { output_tokens: 100, ... } }
assistant (tool_use)  { id: "msg_1", usage: { output_tokens: 100, ... } }
user (tool_result)
user (tool_result)
user (tool_result)

<!-- Step 2: Follow-up response -->
assistant (text)      { id: "msg_2", usage: { output_tokens: 98, ... } }
```

## Important Usage Rules

### 1\. Same ID = Same Usage

**All messages with the same `id` field report identical usage**. When Claude sends multiple messages in the same turn (e.g., text + tool uses), they share the same message ID and usage data.

```
// All these messages have the same ID and usage
const messages = [\
  { type: 'assistant', id: 'msg_123', usage: { output_tokens: 100 } },\
  { type: 'assistant', id: 'msg_123', usage: { output_tokens: 100 } },\
  { type: 'assistant', id: 'msg_123', usage: { output_tokens: 100 } }\
];

// Charge only once per unique message ID
const uniqueUsage = messages[0].usage; // Same for all messages with this ID
```

### 2\. Charge Once Per Step

**You should only charge users once per step**, not for each individual message. When you see multiple assistant messages with the same ID, use the usage from any one of them.

### 3\. Result Message Contains Cumulative Usage

The final `result` message contains the total cumulative usage from all steps in the conversation:

```
// Final result includes total usage
const result = await query({
  prompt: "Multi-step task",
  options: { /* ... */ }
});

console.log("Total usage:", result.usage);
console.log("Total cost:", result.usage.total_cost_usd);
```

## Implementation: Cost Tracking System

Here's a complete example of implementing a cost tracking system:

TypeScript

```
import { query } from "@anthropic-ai/claude-agent-sdk";

class CostTracker {
  private processedMessageIds = new Set<string>();
  private stepUsages: Array<any> = [];

  async trackConversation(prompt: string) {
    const result = await query({
      prompt,
      options: {
        onMessage: (message) => {
          this.processMessage(message);
        }
      }
    });

    return {
      result,
      stepUsages: this.stepUsages,
      totalCost: result.usage?.total_cost_usd || 0
    };
  }

  private processMessage(message: any) {
    // Only process assistant messages with usage
    if (message.type !== 'assistant' || !message.usage) {
      return;
    }

    // Skip if we've already processed this message ID
    if (this.processedMessageIds.has(message.id)) {
      return;
    }

    // Mark as processed and record usage
    this.processedMessageIds.add(message.id);
    this.stepUsages.push({
      messageId: message.id,
      timestamp: new Date().toISOString(),
      usage: message.usage,
      costUSD: this.calculateCost(message.usage)
    });
  }

  private calculateCost(usage: any): number {
    // Implement your pricing calculation here
    // This is a simplified example
    const inputCost = usage.input_tokens * 0.00003;
    const outputCost = usage.output_tokens * 0.00015;
    const cacheReadCost = (usage.cache_read_input_tokens || 0) * 0.0000075;

    return inputCost + outputCost + cacheReadCost;
  }
}

// Usage
const tracker = new CostTracker();
const { result, stepUsages, totalCost } = await tracker.trackConversation(
  "Analyze and refactor this code"
);

console.log(`Steps processed: ${stepUsages.length}`);
console.log(`Total cost: $${totalCost.toFixed(4)}`);
```

## Handling Edge Cases

### Output Token Discrepancies

In rare cases, you might observe different `output_tokens` values for messages with the same ID. When this occurs:

1. **Use the highest value** \- The final message in a group typically contains the accurate total
2. **Verify against total cost** \- The `total_cost_usd` in the result message is authoritative
3. **Report inconsistencies** \- File issues at the [Claude Code GitHub repository](https://github.com/anthropics/claude-code/issues)

### Cache Token Tracking

When using prompt caching, track these token types separately:

```
interface CacheUsage {
  cache_creation_input_tokens: number;
  cache_read_input_tokens: number;
  cache_creation: {
    ephemeral_5m_input_tokens: number;
    ephemeral_1h_input_tokens: number;
  };
}
```

## Best Practices

1. **Use Message IDs for Deduplication**: Always track processed message IDs to avoid double-charging
2. **Monitor the Result Message**: The final result contains authoritative cumulative usage
3. **Implement Logging**: Log all usage data for auditing and debugging
4. **Handle Failures Gracefully**: Track partial usage even if a conversation fails
5. **Consider Streaming**: For streaming responses, accumulate usage as messages arrive

## Usage Fields Reference

Each usage object contains:

- `input_tokens`: Base input tokens processed
- `output_tokens`: Tokens generated in the response
- `cache_creation_input_tokens`: Tokens used to create cache entries
- `cache_read_input_tokens`: Tokens read from cache
- `service_tier`: The service tier used (e.g., "standard")
- `total_cost_usd`: Total cost in USD (only in result message)

## Example: Building a Billing Dashboard

Here's how to aggregate usage data for a billing dashboard:

```
class BillingAggregator {
  private userUsage = new Map<string, {
    totalTokens: number;
    totalCost: number;
    conversations: number;
  }>();

  async processUserRequest(userId: string, prompt: string) {
    const tracker = new CostTracker();
    const { result, stepUsages, totalCost } = await tracker.trackConversation(prompt);

    // Update user totals
    const current = this.userUsage.get(userId) || {
      totalTokens: 0,
      totalCost: 0,
      conversations: 0
    };

    const totalTokens = stepUsages.reduce((sum, step) =>
      sum + step.usage.input_tokens + step.usage.output_tokens, 0
    );

    this.userUsage.set(userId, {
      totalTokens: current.totalTokens + totalTokens,
      totalCost: current.totalCost + totalCost,
      conversations: current.conversations + 1
    });

    return result;
  }

  getUserBilling(userId: string) {
    return this.userUsage.get(userId) || {
      totalTokens: 0,
      totalCost: 0,
      conversations: 0
    };
  }
}
```

## Related Documentation

- [TypeScript SDK Reference](https://platform.claude.com/docs/en/agent-sdk/typescript) \- Complete API documentation
- [SDK Overview](https://platform.claude.com/docs/en/agent-sdk/overview) \- Getting started with the SDK
- [SDK Permissions](https://platform.claude.com/docs/en/agent-sdk/permissions) \- Managing tool permissions

- [Understanding Token Usage](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#understanding-token-usage)
- [Key Concepts](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#key-concepts)
- [Usage Reporting Structure](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#usage-reporting-structure)
- [Single vs Parallel Tool Use](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#single-vs-parallel-tool-use)
- [Message Flow Example](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#message-flow-example)
- [Important Usage Rules](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#important-usage-rules)
- [1\. Same ID = Same Usage](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#1-same-id-same-usage)
- [2\. Charge Once Per Step](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#2-charge-once-per-step)
- [3\. Result Message Contains Cumulative Usage](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#3-result-message-contains-cumulative-usage)
- [Implementation: Cost Tracking System](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#implementation-cost-tracking-system)
- [Handling Edge Cases](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#handling-edge-cases)
- [Output Token Discrepancies](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#output-token-discrepancies)
- [Cache Token Tracking](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#cache-token-tracking)
- [Best Practices](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#best-practices)
- [Usage Fields Reference](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#usage-fields-reference)
- [Example: Building a Billing Dashboard](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#example-building-a-billing-dashboard)
- [Related Documentation](https://platform.claude.com/docs/en/agent-sdk/cost-tracking#related-documentation)

[Claude Docs home page](https://platform.claude.com/docs)

[X (Twitter)](https://x.com/claudeai)[LinkedIn](https://www.linkedin.com/showcase/claude)[Instagram](https://instagram.com/claudeai)

### Solutions

- [AI agents](https://claude.com/solutions/agents)
- [Code modernization](https://claude.com/solutions/code-modernization)
- [Coding](https://claude.com/solutions/coding)
- [Customer support](https://claude.com/solutions/customer-support)
- [Education](https://claude.com/solutions/education)
- [Financial services](https://claude.com/solutions/financial-services)
- [Government](https://claude.com/solutions/government)
- [Life sciences](https://claude.com/solutions/life-sciences)

### Partners

- [Amazon Bedrock](https://claude.com/partners/amazon-bedrock)
- [Google Cloud's Vertex AI](https://claude.com/partners/google-cloud-vertex-ai)

### Learn

- [Blog](https://claude.com/blog)
- [Catalog](https://claude.ai/catalog/artifacts)
- [Courses](https://www.anthropic.com/learn)
- [Use cases](https://claude.com/resources/use-cases)
- [Connectors](https://claude.com/partners/mcp)
- [Customer stories](https://claude.com/customers)
- [Engineering at Anthropic](https://www.anthropic.com/engineering)
- [Events](https://www.anthropic.com/events)
- [Powered by Claude](https://claude.com/partners/powered-by-claude)
- [Service partners](https://claude.com/partners/services)
- [Startups program](https://claude.com/programs/startups)

### Company

- [Anthropic](https://www.anthropic.com/company)
- [Careers](https://www.anthropic.com/careers)
- [Economic Futures](https://www.anthropic.com/economic-futures)
- [Research](https://www.anthropic.com/research)
- [News](https://www.anthropic.com/news)
- [Responsible Scaling Policy](https://www.anthropic.com/news/announcing-our-updated-responsible-scaling-policy)
- [Security and compliance](https://trust.anthropic.com/)
- [Transparency](https://www.anthropic.com/transparency)

### Learn

- [Blog](https://claude.com/blog)
- [Catalog](https://claude.ai/catalog/artifacts)
- [Courses](https://www.anthropic.com/learn)
- [Use cases](https://claude.com/resources/use-cases)
- [Connectors](https://claude.com/partners/mcp)
- [Customer stories](https://claude.com/customers)
- [Engineering at Anthropic](https://www.anthropic.com/engineering)
- [Events](https://www.anthropic.com/events)
- [Powered by Claude](https://claude.com/partners/powered-by-claude)
- [Service partners](https://claude.com/partners/services)
- [Startups program](https://claude.com/programs/startups)

### Help and security

- [Availability](https://www.anthropic.com/supported-countries)
- [Status](https://status.anthropic.com/)
- [Support](https://support.claude.com/)
- [Discord](https://www.anthropic.com/discord)

### Terms and policies

- [Privacy policy](https://www.anthropic.com/legal/privacy)
- [Responsible disclosure policy](https://www.anthropic.com/responsible-disclosure-policy)
- [Terms of service: Commercial](https://www.anthropic.com/legal/commercial-terms)
- [Terms of service: Consumer](https://www.anthropic.com/legal/consumer-terms)
- [Usage policy](https://www.anthropic.com/legal/aup)

Ask Docs
![Chat avatar](https://platform.claude.com/docs/images/book-icon-light.svg)

a.claude.ai

# a.claude.ai is blocked

**a.claude.ai** refused to connect.

ERR\_BLOCKED\_BY\_RESPONSE

**a.claude.ai** refused to connect.

![](<Base64-Image-Removed>)![](<Base64-Image-Removed>)

Invalid domain for site key.

ERROR for site owner:

Invalid domain for site key

reCAPTCHA

[Privacy](https://www.google.com/intl/en/policies/privacy/) \- [Terms](https://www.google.com/intl/en/policies/terms/)